<app-loading-component [loading]="loading()"></app-loading-component>
<div class="flex h-screen w-screen flex-col select-none!">
  <div class="h-15 w-full bg-gray-500 p-3">
    <div class="flex h-full flex-row items-center justify-between">
      <div class="flex items-center gap-2">
        <app-side-menu-component
          class="ml-2"
          (onCreateWorkspace)="onAddWorkspace()"
          (onAiCreateWorkspace)="onAiAddWorkspace()"
        ></app-side-menu-component>
        <button
          (click)="onAiAddWorkspace()"
          class="ml-4 flex h-10 cursor-pointer items-center justify-center gap-3 rounded-lg bg-linear-to-r from-purple-800 to-indigo-900 p-3 text-white shadow-lg transition hover:scale-105 hover:shadow-xl"
        >
          <i class="pi pi-lightbulb text-lg"></i>
          <span>Workspace With AI</span>
        </button>
        @if (!isWorkspaceDeletingModalOpen) {
        <app-dropdown-component
          [formControl]="workspaceControl"
          [options]="workspaces()"
          placeholder="Select Workspace"
          optionLabel="name"
          [addOption]="true"
          (onAdd)="onAddWorkspace()"
          class="ml-4"
        ></app-dropdown-component>
        } @else {
        <span
          class="min-w-50 rounded-lg bg-red-900 p-2 whitespace-nowrap text-white"
          >{{ workspaceControl.value?.name }}</span
        >
        } @if (workspaceControl.value) {
        <app-edit-button-component
          (onDelete)="onWorkspaceDelete()"
          (onEdit)="onWorkspaceEdit()"
          (onAdd)="onCreateNewList()"
          addItemLabel="Add new List"
        ></app-edit-button-component>
        }
      </div>
      <div>
        <div class="flex items-center">
          <input
            class="flex-auto rounded-lg bg-zinc-950 p-2 text-white"
            type="text"
            placeholder="Search Tasks"
            [formControl]="searchControl"
          />
          @if(searchControl.value){
          <button
            class="ml-2 cursor-pointer hover:scale-110"
            (click)="searchControl.reset()"
          >
            <span class="pi pi-times text-white/70"></span>
          </button>
          }
        </div>
      </div>
    </div>
  </div>
  <div
    cdkScrollable
    cdkDropList
    cdkDropListOrientation="horizontal"
    [cdkDropListAutoScrollStep]="40"
    (cdkDropListDropped)="onDropTasklist($event)"
    class="mx-2 mt-4 flex flex-1 flex-row gap-5 overflow-x-auto overflow-y-hidden pb-2"
  >
    <ng-container cdkDropListGroup>
      @for (tasklist of tasklists(); track tasklist.id; let i = $index) {
      <app-tasklist-component
        cdkDrag
        cdkDragLockAxis="x"
        [cdkDragData]="tasklist"
        [cdkDragDisabled]="useListEffect()"
        (onTaskCreate)="onTaskCreate($event)"
        (onTaskDelete)="onTaskDelete($event)"
        (onTasklistEdit)="onTasklistEdit($event)"
        (onTasklistDelete)="onTasklistDelete($event)"
        (onTaskEdit)="onTaskEdit($event)"
        (onTaskDropped)="applySearch()"
        (onTaskDoneReorder)="onTaskDoneReorder()"
        [tasklist]="tasklist"
        [isDeleting]="isListDeleting(tasklist)"
        [taskIdDeleting]="isTaskDeletingModalOpen.data?.taskId"
        [taskIdEditing]="isTaskModalOpen.data?.task?.id"
        [ngClass]="useListEffect() ? (i % 2 ? 'animate-up' : 'animate-down') : null"
      ></app-tasklist-component>
      }
    </ng-container>
    @if (workspaceControl.value && !isWorkspaceDeletingModalOpen) {
    <div class="h-fit min-w-70 rounded-lg border border-zinc-800 bg-[#09090b]">
      <p-button
        (onClick)="onCreateNewList()"
        label="Create new List"
        fluid
        severity="secondary"
        text
        size="small"
        icon="pi pi-plus"
        class="whitespace-nowrap"
      />
    </div>
    }
  </div>
</div>

<app-dialog-component
  header="Are you sure you want to delete this Workspace?"
  [visible]="isWorkspaceDeletingModalOpen"
  (onCancel)="isWorkspaceDeletingModalOpen = false"
  (onConfirm)="deleteWorkspace()"
  [inputValueConfirmation]="workspaceControl.value?.name"
  inputValueConfirmationPlaceholder="Your Workspace name"
></app-dialog-component>

<app-dialog-component
  header="Are you sure you want to delete this List?"
  [visible]="isListDeletingModalOpen.opened"
  (onCancel)="isListDeletingModalOpen.opened = false"
  (onConfirm)="deleteTasklist()"
></app-dialog-component>

<app-dialog-component
  header="Are you sure you want to delete this Task?"
  [visible]="isTaskDeletingModalOpen.opened"
  (onCancel)="onCancelTaskDeleting() "
  (onConfirm)="deleteTask()"
></app-dialog-component>

<app-workspace-modal-component
  [visible]="isWorkspaceModalOpen.opened"
  (onCancel)="onWorkspaceModalCancel()"
  (onSave)="onWorkspaceModalSave($event)"
  [workspace]="isWorkspaceModalOpen.data"
></app-workspace-modal-component>

<app-tasklist-modal-component
  [visible]="isListModalOpen.opened"
  (onCancel)="onListModalCancel()"
  (onSave)="onListModalSave()"
  [workspaceId]="workspaceControl.value?.id!"
  [tasklist]="isListModalOpen.data"
></app-tasklist-modal-component>

<app-task-modal-component
  [visible]="isTaskModalOpen.opened"
  [tasklistId]="isTaskModalOpen.data?.tasklistId!"
  [task]="isTaskModalOpen.data?.task!"
  (onCancel)="onTaskModalCancel()"
  (onSave)="onTaskModalSave()"
></app-task-modal-component>

<app-create-workspace-with-ai-component
  [visible]="isCreateWorkspaceWithAiModalOpen"
  (onCancel)="onAiCreateWorkspaceModalCancel()"
></app-create-workspace-with-ai-component>

<app-request-status-component></app-request-status-component>
